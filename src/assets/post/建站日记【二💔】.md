# å»ºç«™æ—¥è®°ã€äºŒã€‘

ä»Šå¤©çš„ç›®æ ‡æ˜¯åšå‡ºå¥½çœ‹çš„ä»£ç é«˜äº®æ•ˆæœï¼Œç›®å‰å¯¹markdown-itæ”¯æŒåº¦æ¯”è¾ƒå¥½çš„æ¨¡å—æ˜¯`highlight.js`å’Œ`prism`ï¼Œå…¶ä¸­highlight.jsçš„å¯ç©æ€§æ¯”è¾ƒä½ï¼Œæ²¡æœ‰è¡Œå·ã€é«˜äº®æŸä¸€è¡Œè¿™æ ·çš„åŠŸèƒ½ï¼Œprismå¯ä»¥å¾ˆæ–¹ä¾¿åœ°é€šè¿‡æ’ä»¶å®ç°è¿™äº›åŠŸèƒ½ã€‚äºæ˜¯æˆ‘é€‰æ‹©äº†prismï¼Œä½†å›°éš¾é©¬ä¸Šå°±å‡ºç°äº†ï¼Œåœ¨markdown-itæ¸²æŸ“markdownæ–‡ä»¶æ—¶ï¼Œæ˜¯æ²¡æœ‰DOMç»“æ„çš„ï¼Œè¿™æ—¶å€™åªæœ‰tokensï¼Œæ‰€ä»¥é’ˆå¯¹DOMç»“æ„æ¸²æŸ“çš„prismæ’ä»¶æ˜¯æ²¡æœ‰åŠæ³•å·¥ä½œçš„ï¼Œä½†æ˜¯æˆ‘å‘ç°VuePresså¯ä»¥å¾ˆæ–¹ä¾¿çš„å®ç°è¿™äº›åŠŸèƒ½ï¼Œå»çœ‹äº†ä¸‹[VuePress](https://github.com/vuejs/vuepress/tree/master/packages/%40vuepress/markdown/lib)çš„æºç ï¼Œå‘ç°è¿™äº›åŠŸèƒ½éƒ½æ˜¯ä»–ä»¬è‡ªå·±å†™çš„ã€‚

é’»ç ”äº†ä¸€ä¸‹`markdown-it`çš„[æ–‡æ¡£](https://github.com/markdown-it/markdown-it/blob/master/docs/architecture.md)ï¼Œ`markdown-it`çš„æ•°æ®ç»“æ„ä¸ºTokenæµï¼Œ`markdown-it`ç»´æŠ¤äº†ä¸€ä¸ªTokenæµæ•°ç»„ï¼Œæ•°ç»„é‡Œçš„æ¯ä¸€ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªTokenå¯¹è±¡ï¼Œä¸€ä¸ªTokenå¯¹è±¡é‡Œä¹Ÿå¯ä»¥åµŒå¥—å¦ä¸€ä¸ªTokenå¯¹è±¡ï¼Œä¸‹é¢ğŸ‘‡æ˜¯ä¸€ä¸ª`<h1>`æ ‡ç­¾çš„Token
```json
{
    "type": "heading_open",
    "tag": "h1",
    "attrs": null,
    "map": [
      0,
      1
    ],
    "nesting": 1,
    "level": 0,
    "children": null,
    "content": "",
    "markup": "#",
    "info": "",
    "meta": null,
    "block": true,
    "hidden": false
  }
```
`type`å±æ€§è¡¨ç¤ºå½“å‰Tokençš„æè¿°ï¼Œè¿™é‡Œçš„"heading_open"ä»£è¡¨è¿™æ˜¯ä¸€ä¸ªå¼€`h1`æ ‡ç­¾ï¼Œ`tag`å±æ€§æ˜ç¡®è¯´æ˜äº†è¯¥Tokençš„æ ‡ç­¾åç§°ï¼Œ`content`å±æ€§å­˜å‚¨äº†è¯¥Tokençš„å†…å®¹ï¼Œæ˜¾ç„¶`<h1>`æ ‡ç­¾æ˜¯æ²¡æœ‰å†…å®¹çš„ï¼Œä¸‹é¢å±•ç¤ºä¸€ä¸ªæœ‰å†…å®¹çš„Token
```json
{
        "type": "text",
        "tag": "",
        "attrs": null,
        "map": null,
        "nesting": 0,
        "level": 0,
        "children": null,
        "content": "hello",
        "markup": "",
        "info": "",
        "meta": null,
        "block": false,
        "hidden": false
      }
```
æ›´å¤šå…³äºTokençš„è¯¦ç»†ä¿¡æ¯å¯ä»¥ä»è¿™ä¸ª[demo](https://markdown-it.github.io/)ä¸­çš„debugæ¨¡å¼æ‰¾åˆ°ã€‚
å›åˆ°ä»£ç é«˜äº®ï¼Œä»£ç è¯­å¥"\`\`\`\[language\]\{code\}\`\`\`"èƒ½å¤Ÿè‡ªåŠ¨è¢«`markdown-it`ç›‘æµ‹åˆ°ï¼Œå¯¹åº”çš„Tokençš„typeæ˜¯â€œfenceâ€ï¼Œè¯¥Tokençš„infoå±æ€§è®°å½•äº†\[language\]ï¼Œ`markdown-it`ä¹Ÿå®ç°äº†å¯¹åº”çš„rendererçš„rulesï¼Œè¿™ä¸ªfneceè§„åˆ™æœ€ä¸»è¦çš„åŠŸèƒ½å°±æ˜¯æŠŠä»£ç å’Œ\[language\]æå–å‡ºæ¥ï¼Œæœ€ååŒ…è£…æˆhtmlï¼š
```js
return  '<pre><code' + slf.renderAttrs(token) + '>'
    + highlighted
    + '</code></pre>\n';
```
ä¸ºäº†å®ç°æ˜¾ç¤ºè¡Œå·åŠŸèƒ½ï¼Œæˆ‘ä»¬å¸Œæœ›åœ¨å¤–è¾¹å†åŒ…è£¹ä¸€å±‚æ ‡ç­¾ï¼Œç„¶ååœ¨é‡Œè¾¹å†æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼Œæ ‡ç­¾é‡Œçš„å†…å®¹ä¸ºå¯¹åº”çš„è¡Œå·ã€‚äºæ˜¯è€ƒè™‘åˆ©ç”¨åŸæ¥çš„rulesï¼Œå†åœ¨å¤–è¾¹åµŒå¥—ä¸€å±‚ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š
```js
const wrap = (wrapped) => (...args) => {
        const [tokens, idx] = args
        const token = tokens[idx]
        const rawCode = wrapped(...args)
        return `<!--beforebegin--><divclass="language-${token.info.trim()} extra-class">`
            + `<!--afterbegin-->${rawCode}<!--beforeend--></divclass=><!--afterend-->`
    }
    const { fence } = md.renderer.rules
    md.renderer.rules.fence = wrap(fence)
```
æ¥ç€å»å®Œæˆè¡Œå·çš„rulesï¼Œé¦–å…ˆå–å‡ºä¸Šé¢è¿”å›çš„å­—ç¬¦ä¸²ï¼Œé€‰å‡º<code></code>é—´çš„å†…å®¹ï¼Œç„¶åæŠŠè¿™ä¸ªå†…å®¹æŒ‰æ¢è¡Œåˆ‡åˆ†ï¼Œæ¥ç€å°±å¯ä»¥æ¸²æŸ“å‡ºè¡Œå·ã€‚
```js
const fence = md.renderer.rules.fence
md.renderer.rules.fence = (...args) => {
    const rawCode = fence(...args)
    const code = rawCode.slice(
        rawCode.indexOf('<code'),
        rawCode.indexOf('</code>')
    )

    const lines = code.split('\n')
    const lineNumbersCode = [...Array(lines.length - 1)]
        .map((line, index) => `<span class="line-number">${index + 1}</span><br>`).join('')

    const lineNumbersWrapperCode
        = `<div class="line-numbers-wrapper">${lineNumbersCode}</div>`

    const finalCode = rawCode
        .replace('<!--beforeend-->', `${lineNumbersWrapperCode}<!--beforeend-->`)
        .replace('extra-class', 'line-numbers-mode')

    return finalCode
```
æœ€åå†è°ƒæ•´ä¸€ä¸‹æ ·å¼ï¼Œå°±èƒ½å¾—åˆ°æ¼‚äº®çš„ä»£ç æ¡†å•¦ï¼å“åº”å¼è®¾è®¡å’Œä»£ç è¯­è¨€æ˜¾ç¤ºã€ä»£ç å¤åˆ¶çš„åŠŸèƒ½ç•™åˆ°åé¢å†å®ç°
- [ ] å“åº”å¼
- [ ] ä»£ç è¯­è¨€æ˜¾ç¤º
- [ ] ä»£ç å¤åˆ¶
- [ ] ä¸€ç¯‡æ–‡ç« æ˜¾ç¤ºå¤šä¸ªä»£ç å—ï¼ŒåµŒå¥—é€»è¾‘ä¸å¯¹

![](./diary2.png)

## æ˜æ—¥ç›®æ ‡
- [ ] ä¸ºæ¯ç¯‡æ–‡ç« ç”Ÿæˆä¸€ä¸ªé“¾æ¥ï¼Œå¹¶é€šè¿‡ç‚¹å‡»å¡ç‰‡å¯¼èˆªè¿›å…¥
- [ ] checkboxæ¸²æŸ“
- [ ] å›¾ç‰‡æ¸²æŸ“
